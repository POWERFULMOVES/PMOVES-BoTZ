version: "3.9"

x-env-files: &env_files
  - ./env.shared
  - ./.env
  - ./.env.local

services:
  tailscale:
    image: tailscale/tailscale:stable
    hostname: pmoves-mini
    environment:
      - TS_AUTHKEY=${TS_AUTHKEY}
      - TS_STATE_DIR=/var/lib/tailscale
      - TS_USERSPACE=false
      - TS_ACCEPT_DNS=true
    cap_add:
      - NET_ADMIN
      - NET_RAW
    volumes:
      - ./ts-state:/var/lib/tailscale
    network_mode: host
    restart: unless-stopped
    command: >
      sh -lc "
      tailscaled --state=/var/lib/tailscale/tailscaled.state &
      sleep 2 &&
      tailscale up --authkey=${TS_AUTHKEY} --reset --accept-routes=true --ssh=true &&
      tailscale serve https / http://127.0.0.1:2091 &&
      tail -f /dev/null
      "

  mcp-gateway:
    image: alpine:3.20
    working_dir: /app
    entrypoint: ["/bin/sh","-lc"]
    command: >
      "
      apk add --no-cache bash curl python3 py3-pip pipx docker-cli-plugins &&
      pipx ensurepath &&
      docker mcp gateway run --port 2091 --transport streaming --catalog /app/mcp_mini_portable.yaml
      "
    env_file: *env_files
    volumes:
      - ./mcp_mini_portable.yaml:/app/mcp_mini_portable.yaml:ro
    network_mode: host
    restart: unless-stopped

# networks:
#   default:
#     external: true
#     name: pmoves_default