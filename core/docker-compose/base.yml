version: "3.9"

services:
  # 1. Tailscale VPN (Network Layer)
  tailscale:
    image: tailscale/tailscale:latest
    hostname: ${TAILSCALE_HOSTNAME:-pmoves-botz}
    environment:
      - TS_AUTHKEY=${TAILSCALE_AUTHKEY}
      - TS_EXTRA_ARGS=--advertise-tags=${TAILSCALE_TAGS}
      - TS_STATE_DIR=/var/lib/tailscale
      - TS_USERSPACE=false
    volumes:
      - ${PWD}/ts-state:/var/lib/tailscale
      - /dev/net/tun:/dev/net/tun
    cap_add:
      - NET_ADMIN
      - NET_RAW
    restart: unless-stopped
    networks:
      - pmoves_ai

  # 2. MCP Gateway (Orchestrator)
  mcp-gateway:
    image: python:3.11-slim
    working_dir: /app
    volumes:
      - ../../features/gateway/python-gateway:/app
    command: sh -c "pip install fastmcp && python gateway.py"
    environment:
      - PORT=2091
    networks:
      - pmoves_ai
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:2091/health')"]
      interval: 30s
      timeout: 10s
      retries: 3

  # 3. Docling MCP (Document Processing)
  docling-mcp:
    build:
      context: ../../features/docling
      dockerfile: Dockerfile.docling-mcp
    command: python docling_mcp_server.py --transport streamable-http --port 3020
    environment:
      - PORT=3020
    networks:
      - pmoves_ai
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3020/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # 4. E2B Runner (Sandbox Layer)
  e2b-runner:
    build:
      context: ../../features/e2b
      dockerfile: Dockerfile
    working_dir: /app
    volumes:
      - ../../features/e2b:/app
    command: uvicorn app_e2b:app --host 0.0.0.0 --port 7071
    environment:
      - PORT=7071
      - E2B_API_KEY=${E2B_API_KEY}
    networks:
      - pmoves_ai
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:7071/health')"]
      interval: 30s
      timeout: 10s
      retries: 3

  # 5. VL Sentinel (Vision-Language Layer)
  vl-sentinel:
    build:
      context: ../../features/vl_sentinel
      dockerfile: Dockerfile
    working_dir: /app
    volumes:
      - ../../features/vl_sentinel:/app
    command: uvicorn app_vl:app --host 0.0.0.0 --port 7072
    environment:
      OLLAMA_BASE_URL: ""
      PORT: "7072"
    networks:
      - pmoves_ai
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:7072/health')"]
      timeout: 10s
      interval: 30s
      retries: 3

  # 6. Cipher Memory (Data Layer)
  cipher-memory:
    build:
      context: ../../features/cipher
      dockerfile: Dockerfile.cipher
    environment:
      - VENICE_API_KEY=${VENICE_API_KEY}
      - CIPHER_CONFIG_PATH=/app/features/cipher/pmoves_cipher/memAgent/cipher_pmoves.yml
      - CIPHER_MEMORY_PORT=${CIPHER_MEMORY_PORT:-8081}
    volumes:
      - ../../features/cipher/pmoves_cipher:/app/features/cipher/pmoves_cipher:ro
      - cipher_data:/data
    labels:
      pmoves.service: "cipher"
      pmoves.health: "http://cipher-memory:${CIPHER_MEMORY_PORT:-8081}/health"
    networks:
      default:
        aliases: ["pmoves-botz_cipher", "cipher-memory"]
      pmoves_ai: {}

  # 7. YT Mini Agent (YouTube/Media Layer)
  yt-mini:
    build:
      context: ../../features/yt
      dockerfile: Dockerfile
    image: pmoves/yt-mini:dev
    container_name: yt-mini
    environment:
      PMOVES_MODE: yt-mini
    restart: unless-stopped
    command: tail -f /dev/null
    networks:
      - pmoves_ai

volumes:
  cipher_data:
  ts-state:

networks:
  pmoves_ai:
    name: pmoves_ai
    driver: bridge
