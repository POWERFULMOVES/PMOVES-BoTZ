
x-common-env: &common_env
  - TS_AUTHKEY=${TS_AUTHKEY:-${TAILSCALE_AUTHKEY}}
  - TS_STATE_DIR=/var/lib/tailscale

services:
  tailscale:
    image: tailscale/tailscale:stable
    hostname: pmoves-core
    profiles: ["linux"]
    environment: *common_env
    cap_add: [ "NET_ADMIN", "NET_RAW" ]
    volumes:
      - ./core/ts-state:/var/lib/tailscale
    network_mode: host
    restart: unless-stopped
    command: >
      sh -lc "
      tailscaled --state=/var/lib/tailscale/tailscaled.state &
      sleep 2 &&
      tailscale up --authkey=${TS_AUTHKEY} --reset --accept-routes=true --ssh=true &&
      tailscale serve https / http://127.0.0.1:2091 &&
      tail -f /dev/null
      "

  mcp-gateway:
    build: ../../pmoves_multi_agent_pro_pack/mcp_gateway/PMOVES-BotZ-gateway/mcp-proxy-server
    environment:
      MCP_CATALOG_PATH: /app/mcp_catalog.yaml
      POSTMAN_API_KEY: ${POSTMAN_API_KEY}
    volumes:
      - ../mcp_catalog.yaml:/app/mcp_catalog.yaml:ro
    ports:
      - "${GATEWAY_PORT:-2091}:8000"
    restart: unless-stopped
    labels:
      pmoves.service: "gateway"
      pmoves.health: "http://mcp-gateway:8000/ready"
      pmoves.scrape: "http://mcp-gateway:8000/metrics"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/metrics"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s
    networks:
      default:
        aliases: ["${PMZ_NAMESPACE:-pmoves-botz}_gateway", "mcp-gateway"]
      pmoves_ai:
        aliases: ["${PMZ_NAMESPACE:-pmoves-botz}_gateway", "mcp-gateway"]

  # Docling MCP using PMOVES customized server (with /health and /metrics)
  docling-mcp:
    build:
      context: ../../pmoves_multi_agent_pro_pack
      dockerfile: Dockerfile.docling-mcp
    environment:
      DOCLING_MCP_SERVER__TRANSPORT: http
      DOCLING_MCP_SERVER__HOST: 0.0.0.0
      DOCLING_MCP_SERVER__PORT: 3020
      DOCLING_MCP_LOGGING__LEVEL: INFO
      DOCLING_MCP_DOCLING__CACHE_DIR: /data/cache
    volumes:
      - ../../pmoves_multi_agent_pro_pack/data/docling:/data
    ports:
      - "${DOCLING_PORT:-3020}:3020"
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3020/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    labels:
      pmoves.service: "docling"
      pmoves.health: "http://docling-mcp:3020/health"
      pmoves.scrape: "http://docling-mcp:3020/metrics"
    networks:
      default:
        aliases: ["${PMZ_NAMESPACE:-pmoves-botz}_docling", "docling-mcp"]
      pmoves_ai:
        aliases: ["${PMZ_NAMESPACE:-pmoves-botz}_docling", "docling-mcp"]
    

networks:
  default:
    name: ${PMZ_NAMESPACE:-pmoves-botz}_net
  pmoves_ai:
    name: ${PMZ_NAMESPACE:-pmoves-botz}_ai
