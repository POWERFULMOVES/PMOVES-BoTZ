x-env-files: &env_files
  - ./env.shared
  - ./.env
  - ./.env.local

services:
  tailscale:
    image: tailscale/tailscale:stable
    hostname: pmoves-pro
    environment:
      - TAILSCALE_AUTHKEY=${TS_AUTHKEY}
      - TS_STATE_DIR=/var/lib/tailscale
      - TS_USERSPACE=true
      - TS_ACCEPT_DNS=true
      - TS_SOCKET_DIR=/var/run/tailscale
    volumes:
      - ./ts-state:/var/lib/tailscale
      - ./tailscale_final.sh:/tailscale_final.sh:ro
    command: ["/bin/sh", "/tailscale_final.sh"]
    cap_add:
      - NET_ADMIN
      - SYS_MODULE
    devices:
      - /dev/net/tun:/dev/net/tun
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "sh", "-c", "tailscale status || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  mcp-gateway:
    build: ./mcp_gateway
    env_file: *env_files
    volumes:
      - ./mcp_catalog_multi.yaml:/app/mcp_catalog_multi.yaml:ro
    ports:
      - "2091:2091"
    restart: unless-stopped
    depends_on:
      docling-mcp:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:2091/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Docling MCP as standalone HTTP server (using POWERFULMOVES/docling submodule)
  docling-mcp:
    build:
      context: .
      dockerfile: Dockerfile.docling-mcp
    working_dir: /srv
    environment:
      # Configuration via environment variables
      DOCLING_MCP_SERVER__TRANSPORT: ${DOCLING_MCP_TRANSPORT:-http}
      DOCLING_MCP_SERVER__HOST: ${DOCLING_MCP_HOST:-0.0.0.0}
      DOCLING_MCP_SERVER__PORT: ${DOCLING_MCP_PORT:-3020}
      DOCLING_MCP_LOGGING__LEVEL: ${DOCLING_MCP_LOG_LEVEL:-INFO}
      DOCLING_MCP_DOCLING__CACHE_DIR: /data/cache
      DOCLING_MCP_ENVIRONMENT: ${DOCLING_MCP_ENVIRONMENT:-production}
      # Additional environment variables for customization
      DOC_CACHE_DIR: /data/cache
    volumes:
      - ./data/docling:/data
      - ./docling:/srv/docling  # Mount submodule
      - ./config:/srv/config:ro  # Mount configuration directory as read-only
      - docling_logs:/var/log  # Mount logs directory
    ports: 
      - "3020:3020"
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3020/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    command: >
      sh -lc "
      echo 'Starting Docling MCP Server with configuration support...' &&
      echo 'Environment: ${DOCLING_MCP_ENVIRONMENT:-production}' &&
      echo 'Transport: ${DOCLING_MCP_TRANSPORT:-http}' &&
      echo 'Host: ${DOCLING_MCP_HOST:-0.0.0.0}' &&
      echo 'Port: ${DOCLING_MCP_PORT:-3020}' &&
      python docling_mcp_server.py --environment ${DOCLING_MCP_ENVIRONMENT:-production}
      "

  # E2B sandbox runner shim (HTTP) — uses E2B Python SDK
  e2b-runner:
    build: ./e2b_shim
    environment:
      E2B_API_KEY: ${E2B_API_KEY}
      SANDBOX_TTL_SEC: ${SANDBOX_TTL_SEC:-1800}
    ports: [ "7071:7071" ]
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:7071/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # Vision-Language sentinel (guidance/monitoring) — pluggable provider
  vl-sentinel:
    build: ./vl_sentinel
    environment:
      VL_PROVIDER: ${VL_PROVIDER:-ollama}
      VL_MODEL: ${VL_MODEL:-qwen2.5-vl:14b}
      OLLAMA_BASE_URL: ${OLLAMA_BASE_URL:-http://host.docker.internal:11434}
      OPENAI_API_KEY: ${OPENAI_API_KEY:-}
    ports: [ "7072:7072" ]
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:7072/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # Cipher Memory MCP server with Pmoves-cipher integration
  cipher-memory:
    build:
      context: ./memory_shim
      dockerfile: Dockerfile.cipher
    environment:
      VENICE_API_KEY: ${VENICE_API_KEY}
      CIPHER_CONFIG_PATH: /app/memory_shim/pmoves_cipher/memAgent/cipher_pmoves.yml
      PMOVES_ROOT: /app
      CIPHER_UI_PORT: 3010
      CIPHER_API_PORT: 3011
      CIPHER_UI_MODE: "true"
    volumes:
      - ./memory_shim/pmoves_cipher:/app/memory_shim/pmoves_cipher:ro
      - cipher_data:/data
    ports:
      - "3010:3010"  # Web UI port
      - "3011:3011"  # API port
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3011/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

# Optional: run Postman MCP locally (STDIO) in Node — prefer hosted HTTP.
#  postman-mcp-local:
#    image: node:20-alpine
#    working_dir: /srv
#    command: ["npx","@postman/postman-mcp-server@latest","--full"]
#    environment:
#      POSTMAN_API_KEY: ${POSTMAN_API_KEY}
#    ports: [ "7073:7073" ]
#    restart: unless-stopped
#    healthcheck:
#      test: ["CMD", "curl", "-f", "http://localhost:7073/health"]
#      interval: 30s
#      timeout: 10s
#      retries: 3
#      start_period: 10s

volumes:
  cipher_data:
  docling_logs: